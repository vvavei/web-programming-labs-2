{% extends "base.html" %}

{% block lab %}Камера хранения{% endblock %}

{% block script %}
<script>
    // Функция для получения списка ячеек
    function getCellList() {
        fetch('/rgz/cells/')
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                const cells = data.cells;
                const totalCells = data.total_cells;
                const bookedCells = data.booked_cells;
                const freeCells = data.free_cells;
                const isAuthorized = data.is_authorized; // Проверяем, авторизован ли пользователь
    
                const tbody = document.getElementById('cell-list');
                tbody.innerHTML = ''; // Очищаем таблицу перед обновлением
    
                // Удаляем старые элементы с информацией о количестве ячеек
                const infoContainer = document.getElementById('cell-info-container');
                infoContainer.innerHTML = '';
    
                // Добавляем информацию о количестве ячеек
                infoContainer.innerHTML = `
                    <p>Общее количество ячеек: ${totalCells}</p>
                    <p>Забронировано ячеек: ${bookedCells}</p>
                    <p>Свободных ячеек: ${freeCells}</p>
                `;
    
                // Добавляем данные о ячейках
                for (let i = 0; i < cells.length; i++) {
                    const cell = cells[i];
                    const tr = document.createElement('tr');
    
                    const tdId = document.createElement('td');
                    const tdStatus = document.createElement('td');
                    const tdUser = document.createElement('td');
                    const tdActions = document.createElement('td');
    
                    tdId.innerText = cell.id;
                    tdStatus.innerText = cell.is_booked ? 'Занята' : 'Свободна';
                    tdUser.innerText = cell.user_login || 'Нет';
    
                    // Если пользователь авторизован, показываем кнопки для бронирования и отмены бронирования
                    if (isAuthorized) {
                        // Кнопка для бронирования
                        const bookButton = document.createElement('button');
                        bookButton.innerText = 'Забронировать';
                        bookButton.onclick = function () {
                            bookCell(cell.id);
                        };
    
                        // Кнопка для отмены бронирования
                        const cancelButton = document.createElement('button');
                        cancelButton.innerText = 'Отменить бронь';
                        cancelButton.onclick = function () {
                            cancelCell(cell.id);
                        };
    
                        tdActions.append(bookButton);
                        tdActions.append(cancelButton);
                    } else {
                        // Если пользователь не авторизован, показываем сообщение
                        tdActions.innerText = 'Для бронирования нужно авторизоваться';
                    }
    
                    tr.append(tdId);
                    tr.append(tdStatus);
                    tr.append(tdUser);
                    tr.append(tdActions);
    
                    tbody.append(tr);
                }
            })
            .catch(function (error) {
                console.error('Ошибка при получении списка ячеек:', error);
            });
    }

    // Функция для бронирования ячейки через PUT
    function bookCell(cellId) {
        fetch(`/rgz/cells/${cellId}/book/`, {
            method: 'PUT', // Используем PUT 
            headers: { 'Content-Type': 'application/json' }
        })
        .then(function (response) {
            return response.json();
        })
        .then(function (data) {
            if (data.error) {
                alert(data.error);
            } else {
                alert('Ячейка успешно забронирована');
                getCellList(); // Обновляем список ячеек
            }
        })
        .catch(function (error) {
            console.error('Ошибка при бронировании ячейки:', error);
        });
    }

    // Функция для отмены бронирования ячейки
    function cancelCell(cellId) {
        fetch(`/rgz/cells/${cellId}/cancel/`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(function (response) {
            return response.json();
        })
        .then(function (data) {
            if (data.error) {
                alert(data.error);
            } else {
                alert('Бронь успешно отменена');
                getCellList(); // Обновляем список ячеек
            }
        })
        .catch(function (error) {
            console.error('Ошибка при отмене бронирования ячейки:', error);
        });
    }

    function deleteAccount() {
        if (!confirm('Вы уверены, что хотите удалить аккаунт?')) {
            return;
        }
    
        fetch('/rgz/delete_account', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(function (response) {
            return response.json();
        })
        .then(function (data) {
            if (data.error) {
                alert(data.error);
            } else {
                alert('Аккаунт успешно удален');
                window.location.href = '/rgz/'; // Перенаправляем на главную страницу
            }
        })
        .catch(function (error) {
            console.error('Ошибка при удалении аккаунта:', error);
        });
    }

    // Загрузка списка ячеек при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {
        getCellList();
    });
</script>
{% endblock %}

{% block main %}
    <h1>Камера хранения</h1>
    {% if session.login %}
    <p>Добро пожаловать, {{ session.login }}!</p>
    <form action="/rgz/logout" method="POST">
        <button type="submit">Выйти</button>
    </form>
    <form onsubmit="deleteAccount(); return false;">
        <button type="submit" style="color: red;">Удалить аккаунт</button>
    </form>
    {% else %}
    <p>Добро пожаловать! Вы можете посмотреть список ячеек, но для бронирования нужно <a href="/rgz/login">авторизоваться</a>.</p>
    {% endif %}
    <div id="cell-info-container"></div>
    <table border="1">
        <thead>
            <tr>
                <th>ID</th>
                <th>Статус</th>
                <th>Забронирована пользователем</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody id="cell-list"></tbody>
    </table>

{% endblock %}

