{% extends "base.html" %}

{% block lab %}Камера хранения{% endblock %}

{% block script %}
<script>
    // Функция для получения списка ячеек
    function getCellList() {
        fetch('/rgz/cells/')
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                const cells = data.cells;
                const totalCells = data.total_cells;
                const bookedCells = data.booked_cells;
                const freeCells = data.free_cells;
                const isAuthorized = data.is_authorized; // Проверяем, авторизован ли пользователь
    
                const cellGrid = document.getElementById('cell-grid');
                cellGrid.innerHTML = ''; // Очищаем контейнер перед обновлением
    
                // Добавляем информацию о количестве ячеек
                const infoContainer = document.getElementById('cell-info-container');
                infoContainer.innerHTML = `
                    <p>Общее количество ячеек: ${totalCells}</p>
                    <p>Забронировано ячеек: ${bookedCells}</p>
                    <p>Свободных ячеек: ${freeCells}</p>
                `;
    
                // Добавляем данные о ячейках
                for (let i = 0; i < cells.length; i++) {
                    const cell = cells[i];
                    const cellDiv = document.createElement('div');
                    cellDiv.classList.add('cell');
                    cellDiv.innerText = cell.id;
    
                    // Устанавливаем стиль в зависимости от статуса ячейки
                    if (cell.is_booked) {
                        cellDiv.classList.add('booked');
                        const userLogin = document.createElement('div');
                        userLogin.classList.add('user-login');
                        userLogin.innerText = cell.user_login || 'Неизвестный пользователь';
                        cellDiv.appendChild(userLogin);
                    } else {
                        cellDiv.classList.add('free');
                    }
    
                    // Если пользователь авторизован, добавляем обработчики событий
                    if (isAuthorized) {
                        cellDiv.onclick = function () {
                            if (cell.is_booked) {
                                cancelCell(cell.id); // Отмена бронирования
                            } else {
                                bookCell(cell.id); // Бронирование
                            }
                        };
                    }
    
                    cellGrid.appendChild(cellDiv);
                }
            })
            .catch(function (error) {
                console.error('Ошибка при получении списка ячеек:', error);
            });
    }

    function bookCell(cellId) {
        fetch(`/rgz/cells/${cellId}/book/`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert('Ячейка успешно забронирована');
                    getCellList(); // Обновляем список ячеек
                }
            })
            .catch(function (error) {
                console.error('Ошибка при бронировании ячейки:', error);
            });
    }
    
    // Функция для отмены бронирования ячейки
    function cancelCell(cellId) {
        fetch(`/rgz/cells/${cellId}/cancel/`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert('Бронь успешно отменена');
                    getCellList(); // Обновляем список ячеек
                }
            })
            .catch(function (error) {
                console.error('Ошибка при отмене бронирования ячейки:', error);
            });
    }

    function deleteAccount() {
        if (!confirm('Вы уверены, что хотите удалить аккаунт?')) {
            return;
        }
    
        fetch('/rgz/delete_account', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(function (response) {
            return response.json();
        })
        .then(function (data) {
            if (data.error) {
                alert(data.error);
            } else {
                alert('Аккаунт успешно удален');
                window.location.href = '/rgz/'; // Перенаправляем на главную страницу
            }
        })
        .catch(function (error) {
            console.error('Ошибка при удалении аккаунта:', error);
        });
    }

    // Загрузка списка ячеек при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {
        getCellList();
    });
</script>
{% endblock %}

{% block main %}
<style>
    .cell {
        width: 50px;
        height: 50px;
        border: 1px solid #ccc;
        display: inline-block;
        margin: 5px;
        text-align: center;
        line-height: 50px;
        font-size: 14px;
        cursor: pointer;
        position: relative;
    }

    .cell.booked {
        background-color: black;
        color: white;
    }

    .cell.free {
        background-color: white;
        color: black;
    }

    .cell .user-login {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        font-size: 10px;
        color: white;
        background-color: rgba(0, 0, 0, 0.5);
    }
</style>
    <h1>Камера хранения</h1>
    {% if session.login %}
    <p>Добро пожаловать, {{ session.login }}!</p>
    <form action="/rgz/logout" method="POST">
        <button type="submit">Выйти</button>
    </form>
    <form onsubmit="deleteAccount(); return false;">
        <button type="submit" style="color: red;">Удалить аккаунт</button>
    </form>
    {% else %}
    <p>Добро пожаловать! Вы можете посмотреть список ячеек, но для бронирования нужно <a href="/rgz/login">авторизоваться</a>.</p>
    {% endif %}

    <div id="cell-info-container"></div>
    <div id="cell-grid">
        <!-- Здесь будут отображаться ячейки -->
    </div>
{% endblock %}

